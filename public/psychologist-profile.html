<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Профиль психолога - PsychPlatform</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <nav class="nav">
    <div class="container nav-container">
      <a href="/" class="nav-brand">PsychPlatform</a>
      <ul class="nav-menu">
        <li><a href="/" class="nav-link">Поиск</a></li>
        <li id="nav-dashboard" class="hidden"><a href="#" id="dashboard-link" class="nav-link">Кабинет</a></li>
        <li><button class="btn btn-sm" id="logout-btn">Выйти</button></li>
      </ul>
    </div>
  </nav>
  
  <div class="container" style="margin-top: 40px;">
    <div id="profile-content">
      <div class="spinner"></div>
    </div>
  </div>
  
  <!-- Booking Modal -->
  <div id="booking-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Записаться на консультацию</h2>
        <button class="modal-close" onclick="closeBookingModal()">&times;</button>
      </div>
      
      <form id="booking-form">
        <div class="form-group">
          <label class="form-label">Дата и время</label>
          <input type="datetime-local" id="booking-datetime" class="form-input" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Формат консультации</label>
          <select id="booking-format" class="form-select" required>
            <option value="">Выберите формат</option>
            <option value="video">Видео</option>
            <option value="audio">Аудио</option>
            <option value="chat">Чат</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Комментарий (необязательно)</label>
          <textarea id="booking-notes" class="form-textarea" rows="3"></textarea>
        </div>
        
        <div id="booking-error" class="alert alert-danger hidden"></div>
        
        <button type="submit" class="btn w-full">Записаться</button>
      </form>
    </div>
  </div>
  
  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    let currentUser = null;
    let psychologist = null;
    
    // Get psychologist ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const psychologistId = urlParams.get('id');
    
    // Initialize auth
    Auth.init().then(user => {
      currentUser = user;
      if (user) {
        document.getElementById('nav-dashboard').classList.remove('hidden');
        const link = document.getElementById('dashboard-link');
        link.href = user.role === 'client' ? '/client-dashboard.html' : 
                    user.role === 'psychologist' ? '/psychologist-dashboard.html' :
                    '/admin-dashboard.html';
      }
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await Auth.logout();
      window.location.href = '/';
    });
    
    // Load psychologist profile
    async function loadProfile() {
      if (!psychologistId) {
        document.getElementById('profile-content').innerHTML = '<p class="text-danger">Психолог не найден</p>';
        return;
      }
      
      try {
        psychologist = await API.psychologists.get(psychologistId);
        const reviews = await API.reviews.getByPsychologist(psychologistId);
        
        document.getElementById('profile-content').innerHTML = `
          <div class="grid grid-cols-3">
            <div class="card" style="grid-column: span 2;">
              <h1 class="mb-3">${psychologist.user.firstName} ${psychologist.user.lastName}</h1>
              <p class="text-lg text-secondary mb-3">${psychologist.specialization}</p>
              
              <div class="mb-3">
                <p class="mb-2"><strong>Опыт работы:</strong> ${psychologist.experience} лет</p>
                <p class="mb-2"><strong>Образование:</strong> ${psychologist.education}</p>
                <p class="mb-2"><strong>Рейтинг:</strong> ${psychologist.rating || 0} ⭐ (${psychologist.totalReviews} отзывов)</p>
              </div>
              
              <h3 class="mb-2">О себе</h3>
              <p class="mb-3">${psychologist.description}</p>
              
              <h3 class="mb-2">Сертификаты</h3>
              <ul class="mb-3">
                ${psychologist.certifications && psychologist.certifications.length > 0
                  ? psychologist.certifications.map(cert => `<li>${cert}</li>`).join('')
                  : '<li>Не указаны</li>'}
              </ul>
              
              <h3 class="mb-2">Форматы работы</h3>
              <div class="flex gap-2 mb-3">
                ${psychologist.formats && psychologist.formats.length > 0
                  ? psychologist.formats.map(format => `
                      <span class="badge">${format === 'video' ? 'Видео' : format === 'audio' ? 'Аудио' : 'Чат'}</span>
                    `).join('')
                  : '<span class="badge">Не указаны</span>'}
              </div>
            </div>
            
            <div>
              <div class="card">
                <h3 class="text-2xl text-primary mb-3">${psychologist.price} ₽</h3>
                <p class="text-sm text-secondary mb-3">за консультацию (50 минут)</p>
                ${currentUser && currentUser.role === 'client' 
                  ? '<button class="btn w-full" onclick="openBookingModal()">Записаться</button>'
                  : '<p class="text-sm text-secondary">Войдите как клиент, чтобы записаться</p>'}
              </div>
            </div>
          </div>
          
          <div class="card mt-4">
            <h2 class="mb-3">Отзывы клиентов</h2>
            ${reviews.length > 0
              ? reviews.map(review => `
                  <div class="card" style="background: var(--color-bg-secondary);">
                    <div class="flex justify-between mb-2">
                      <h4 class="mb-0">${review.client.firstName} ${review.client.lastName}</h4>
                      <span class="text-primary">⭐ ${review.rating}/5</span>
                    </div>
                    <p>${review.comment || 'Без комментария'}</p>
                  </div>
                `).join('')
              : '<p class="text-secondary">Пока нет отзывов</p>'}
          </div>
        `;
      } catch (error) {
        document.getElementById('profile-content').innerHTML = `<p class="text-danger">Ошибка: ${error.message}</p>`;
      }
    }
    
    // Open booking modal
    function openBookingModal() {
      if (!currentUser || currentUser.role !== 'client') {
        alert('Только клиенты могут записываться на консультации');
        return;
      }
      document.getElementById('booking-modal').classList.add('active');
    }
    
    // Close booking modal
    function closeBookingModal() {
      document.getElementById('booking-modal').classList.remove('active');
    }
    
    // Submit booking
    document.getElementById('booking-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const errorEl = document.getElementById('booking-error');
      errorEl.classList.add('hidden');
      
      try {
        const data = {
          clientId: currentUser.id,
          psychologistId: psychologist.id,
          dateTime: new Date(document.getElementById('booking-datetime').value).toISOString(),
          format: document.getElementById('booking-format').value,
          price: psychologist.price,
          notes: document.getElementById('booking-notes').value || null,
          duration: 50
        };
        
        await API.appointments.create(data);
        alert('Запись успешно создана!');
        closeBookingModal();
        window.location.href = '/client-dashboard.html';
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.classList.remove('hidden');
      }
    });
    
    // Make functions global
    window.openBookingModal = openBookingModal;
    window.closeBookingModal = closeBookingModal;
    
    // Load profile
    loadProfile();
  </script>
</body>
</html>
