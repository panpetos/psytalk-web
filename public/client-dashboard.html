<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Личный кабинет клиента - PsychPlatform</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <nav class="nav">
    <div class="container nav-container">
      <a href="/" class="nav-brand">PsychPlatform</a>
      <ul class="nav-menu">
        <li><a href="/edit-profile.html" class="nav-link">Профиль</a></li>
        <li><button class="btn btn-sm" id="logout-btn">Выйти</button></li>
      </ul>
    </div>
  </nav>
  
  <div class="container" style="margin-top: 40px;">
    <h1 class="mb-4">Личный кабинет клиента</h1>
    
    <div class="tabs">
      <ul class="tab-list">
        <li><button class="tab-button active" data-tab="appointments">Мои записи</button></li>
        <li><button class="tab-button" data-tab="search">Поиск психологов</button></li>
        <li><button class="tab-button" data-tab="history">История</button></li>
      </ul>
    </div>
    
    <!-- Appointments Tab -->
    <div id="appointments-tab" class="tab-content active">
      <h2>Предстоящие консультации</h2>
      <div id="upcoming-appointments">
        <div class="spinner"></div>
      </div>
      
      <h2 class="mt-4">Прошедшие консультации</h2>
      <div id="past-appointments">
        <div class="spinner"></div>
      </div>
    </div>
    
    <!-- Search Tab -->
    <div id="search-tab" class="tab-content">
      <h2>Поиск психологов</h2>
      <p><a href="/" class="text-primary">Перейти на страницу поиска →</a></p>
    </div>
    
    <!-- History Tab -->
    <div id="history-tab" class="tab-content">
      <h2>История консультаций</h2>
      <div id="all-appointments">
        <div class="spinner"></div>
      </div>
    </div>
  </div>
  
  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    let currentUser = null;
    let appointments = [];
    
    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.dataset.tab;
        
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(`${tab}-tab`).classList.add('active');
      });
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await Auth.logout();
      window.location.href = '/';
    });
    
    // Format date
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // Render appointment card
    function renderAppointment(apt) {
      const isPast = new Date(apt.dateTime) < new Date();
      const statusText = {
        scheduled: 'Запланирована',
        in_progress: 'В процессе',
        completed: 'Завершена',
        cancelled: 'Отменена'
      }[apt.status] || apt.status;
      
      return `
        <div class="card">
          <div class="flex justify-between items-center mb-2">
            <h3 class="mb-0">${apt.psychologist.user.firstName} ${apt.psychologist.user.lastName}</h3>
            <span class="badge">${statusText}</span>
          </div>
          <p class="text-sm text-secondary mb-2">${apt.psychologist.specialization}</p>
          <p class="mb-2"><strong>Дата:</strong> ${formatDate(apt.dateTime)}</p>
          <p class="mb-2"><strong>Формат:</strong> ${apt.format === 'video' ? 'Видео' : apt.format === 'audio' ? 'Аудио' : 'Чат'}</p>
          <p class="mb-2"><strong>Стоимость:</strong> ${apt.price} ₽</p>
          ${apt.status === 'scheduled' ? `
            <div class="flex gap-2 mt-3">
              <button class="btn btn-sm" onclick="startConsultation('${apt.id}')">Начать консультацию</button>
              <button class="btn btn-sm btn-danger" onclick="cancelAppointment('${apt.id}')">Отменить</button>
            </div>
          ` : ''}
          ${apt.status === 'completed' ? `
            <button class="btn btn-sm mt-3" onclick="leaveReview('${apt.id}', '${apt.psychologistId}')">Оставить отзыв</button>
          ` : ''}
        </div>
      `;
    }
    
    // Load appointments
    async function loadAppointments() {
      try {
        appointments = await API.appointments.getByClient(currentUser.id);
        
        const now = new Date();
        const upcoming = appointments.filter(apt => 
          new Date(apt.dateTime) > now && apt.status === 'scheduled'
        );
        const past = appointments.filter(apt => 
          new Date(apt.dateTime) <= now || apt.status !== 'scheduled'
        );
        
        const upcomingEl = document.getElementById('upcoming-appointments');
        const pastEl = document.getElementById('past-appointments');
        const allEl = document.getElementById('all-appointments');
        
        upcomingEl.innerHTML = upcoming.length > 0 
          ? upcoming.map(renderAppointment).join('')
          : '<p class="text-secondary">Нет предстоящих консультаций</p>';
          
        pastEl.innerHTML = past.length > 0 
          ? past.slice(0, 3).map(renderAppointment).join('')
          : '<p class="text-secondary">Нет прошедших консультаций</p>';
          
        allEl.innerHTML = appointments.length > 0 
          ? appointments.map(renderAppointment).join('')
          : '<p class="text-secondary">Нет консультаций</p>';
          
      } catch (error) {
        console.error('Error loading appointments:', error);
      }
    }
    
    // Cancel appointment
    async function cancelAppointment(id) {
      if (!confirm('Вы уверены, что хотите отменить эту консультацию?')) return;
      
      try {
        await API.appointments.update(id, { status: 'cancelled' });
        await loadAppointments();
        alert('Консультация отменена');
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }
    
    // Start consultation
    function startConsultation(id) {
      window.location.href = `/consultation.html?id=${id}`;
    }
    
    // Leave review
    function leaveReview(appointmentId, psychologistId) {
      window.location.href = `/leave-review.html?appointment=${appointmentId}&psychologist=${psychologistId}`;
    }
    
    // Make functions global
    window.cancelAppointment = cancelAppointment;
    window.startConsultation = startConsultation;
    window.leaveReview = leaveReview;
    
    // Initialize
    Auth.requireAuth('client').then(ok => {
      if (ok) {
        currentUser = Auth.getUser();
        loadAppointments();
      }
    });
  </script>
</body>
</html>
