<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Кабинет психолога - PsychPlatform</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <nav class="nav">
    <div class="container nav-container">
      <a href="/" class="nav-brand">PsychPlatform</a>
      <ul class="nav-menu">
        <li><a href="/edit-profile.html" class="nav-link">Профиль</a></li>
        <li><button class="btn btn-sm" id="logout-btn">Выйти</button></li>
      </ul>
    </div>
  </nav>
  
  <div class="container" style="margin-top: 40px;">
    <h1 class="mb-4">Кабинет психолога</h1>
    
    <div class="tabs">
      <ul class="tab-list">
        <li><button class="tab-button active" data-tab="appointments">Записи</button></li>
        <li><button class="tab-button" data-tab="schedule">Расписание</button></li>
        <li><button class="tab-button" data-tab="reviews">Отзывы</button></li>
      </ul>
    </div>
    
    <!-- Appointments Tab -->
    <div id="appointments-tab" class="tab-content active">
      <h2>Предстоящие консультации</h2>
      <div id="upcoming-appointments"><div class="spinner"></div></div>
      
      <h2 class="mt-4">История консультаций</h2>
      <div id="past-appointments"><div class="spinner"></div></div>
    </div>
    
    <!-- Schedule Tab -->
    <div id="schedule-tab" class="tab-content">
      <h2>Расписание работы</h2>
      <p class="text-secondary mb-3">Настройте свое доступное время для консультаций</p>
      <div id="schedule-content">
        <p class="text-secondary">Функция управления расписанием будет добавлена в следующей версии</p>
      </div>
    </div>
    
    <!-- Reviews Tab -->
    <div id="reviews-tab" class="tab-content">
      <h2>Отзывы клиентов</h2>
      <div id="reviews-list"><div class="spinner"></div></div>
    </div>
  </div>
  
  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    let currentUser = null;
    let psychologist = null;
    
    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.dataset.tab;
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(`${tab}-tab`).classList.add('active');
        
        if (tab === 'reviews') loadReviews();
      });
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await Auth.logout();
      window.location.href = '/';
    });
    
    // Format date
    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleString('ru-RU', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }
    
    // Load appointments
    async function loadAppointments() {
      try {
        const appointments = await API.appointments.getByPsychologist(psychologist.id);
        const now = new Date();
        
        const upcoming = appointments.filter(apt => 
          new Date(apt.dateTime) > now && apt.status === 'scheduled'
        );
        const past = appointments.filter(apt => 
          new Date(apt.dateTime) <= now || apt.status !== 'scheduled'
        );
        
        document.getElementById('upcoming-appointments').innerHTML = upcoming.length > 0 
          ? upcoming.map(apt => `
              <div class="card">
                <h3>${apt.client.firstName} ${apt.client.lastName}</h3>
                <p><strong>Дата:</strong> ${formatDate(apt.dateTime)}</p>
                <p><strong>Формат:</strong> ${apt.format}</p>
                <p><strong>Стоимость:</strong> ${apt.price} ₽</p>
                <button class="btn btn-sm mt-2" onclick="window.location.href='/consultation.html?id=${apt.id}'">Начать</button>
              </div>
            `).join('')
          : '<p class="text-secondary">Нет предстоящих консультаций</p>';
          
        document.getElementById('past-appointments').innerHTML = past.length > 0 
          ? past.slice(0, 5).map(apt => `
              <div class="card">
                <div class="flex justify-between">
                  <div>
                    <h4 class="mb-1">${apt.client.firstName} ${apt.client.lastName}</h4>
                    <p class="text-sm">${formatDate(apt.dateTime)}</p>
                  </div>
                  <span class="badge">${apt.status}</span>
                </div>
              </div>
            `).join('')
          : '<p class="text-secondary">Нет прошедших консультаций</p>';
      } catch (error) {
        console.error('Error loading appointments:', error);
      }
    }
    
    // Load reviews
    async function loadReviews() {
      try {
        const reviews = await API.reviews.getByPsychologist(psychologist.id);
        document.getElementById('reviews-list').innerHTML = reviews.length > 0
          ? reviews.map(review => `
              <div class="card">
                <div class="flex justify-between mb-2">
                  <h4 class="mb-0">${review.client.firstName} ${review.client.lastName}</h4>
                  <span class="text-primary">⭐ ${review.rating}/5</span>
                </div>
                <p class="text-sm text-secondary mb-2">${formatDate(review.createdAt)}</p>
                <p>${review.comment || 'Без комментария'}</p>
              </div>
            `).join('')
          : '<p class="text-secondary">Пока нет отзывов</p>';
      } catch (error) {
        console.error('Error loading reviews:', error);
      }
    }
    
    // Initialize
    Auth.requireAuth('psychologist').then(async ok => {
      if (ok) {
        currentUser = Auth.getUser();
        psychologist = await API.psychologists.getByUserId(currentUser.id);
        if (!psychologist.isApproved) {
          alert('Ваш профиль ожидает проверки администратора');
        }
        loadAppointments();
      }
    });
  </script>
</body>
</html>
