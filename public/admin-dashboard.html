<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель - PsychPlatform</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <nav class="nav">
    <div class="container nav-container">
      <a href="/" class="nav-brand">PsychPlatform</a>
      <ul class="nav-menu">
        <li><button class="btn btn-sm" id="logout-btn">Выйти</button></li>
      </ul>
    </div>
  </nav>
  
  <div class="container" style="margin-top: 40px;">
    <h1 class="mb-4">Админ-панель</h1>
    
    <!-- Stats -->
    <div class="grid grid-cols-3 mb-4">
      <div class="card text-center">
        <h3 class="text-primary" id="stat-users">-</h3>
        <p class="text-sm text-secondary mb-0">Всего пользователей</p>
      </div>
      <div class="card text-center">
        <h3 class="text-primary" id="stat-psychologists">-</h3>
        <p class="text-sm text-secondary mb-0">Психологов</p>
      </div>
      <div class="card text-center">
        <h3 class="text-primary" id="stat-pending">-</h3>
        <p class="text-sm text-secondary mb-0">На модерации</p>
      </div>
    </div>
    
    <div class="tabs">
      <ul class="tab-list">
        <li><button class="tab-button active" data-tab="pending">Модерация</button></li>
        <li><button class="tab-button" data-tab="users">Пользователи</button></li>
      </ul>
    </div>
    
    <!-- Pending Tab -->
    <div id="pending-tab" class="tab-content active">
      <h2>Психологи на модерации</h2>
      <div id="pending-list"><div class="spinner"></div></div>
    </div>
    
    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <h2>Все пользователи</h2>
      <div id="users-list"><div class="spinner"></div></div>
    </div>
  </div>
  
  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.dataset.tab;
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(`${tab}-tab`).classList.add('active');
        
        if (tab === 'users') loadUsers();
      });
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await Auth.logout();
      window.location.href = '/';
    });
    
    // Load stats
    async function loadStats() {
      try {
        const stats = await API.admin.getStats();
        document.getElementById('stat-users').textContent = stats.totalUsers;
        document.getElementById('stat-psychologists').textContent = stats.totalPsychologists;
        document.getElementById('stat-pending').textContent = stats.pendingPsychologists;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
    
    // Load pending psychologists
    async function loadPending() {
      try {
        const pending = await API.admin.getPendingPsychologists();
        document.getElementById('pending-list').innerHTML = pending.length > 0
          ? pending.map(psych => `
              <div class="card">
                <h3>${psych.user.firstName} ${psych.user.lastName}</h3>
                <p class="text-sm text-secondary mb-2">${psych.user.email}</p>
                <p class="mb-2"><strong>Специализация:</strong> ${psych.specialization}</p>
                <p class="mb-2"><strong>Опыт:</strong> ${psych.experience} лет</p>
                <p class="mb-2"><strong>Образование:</strong> ${psych.education}</p>
                <p class="mb-3">${psych.description}</p>
                <div class="flex gap-2">
                  <button class="btn btn-sm" onclick="approve('${psych.id}')">Одобрить</button>
                  <button class="btn btn-sm btn-danger" onclick="reject('${psych.id}')">Отклонить</button>
                </div>
              </div>
            `).join('')
          : '<p class="text-secondary">Нет психологов на модерации</p>';
      } catch (error) {
        console.error('Error loading pending:', error);
      }
    }
    
    // Load all users
    async function loadUsers() {
      try {
        const users = await API.admin.getUsers();
        document.getElementById('users-list').innerHTML = users.length > 0
          ? `
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="border-bottom: 2px solid var(--color-border);">
                    <th style="text-align: left; padding: 12px;">Имя</th>
                    <th style="text-align: left; padding: 12px;">Email</th>
                    <th style="text-align: left; padding: 12px;">Роль</th>
                    <th style="text-align: left; padding: 12px;">Статус</th>
                  </tr>
                </thead>
                <tbody>
                  ${users.map(user => `
                    <tr style="border-bottom: 1px solid var(--color-border);">
                      <td style="padding: 12px;">${user.firstName} ${user.lastName}</td>
                      <td style="padding: 12px;">${user.email}</td>
                      <td style="padding: 12px;"><span class="badge">${user.role}</span></td>
                      <td style="padding: 12px;">
                        ${user.isVerified ? '<span class="badge badge-success">Верифицирован</span>' : '<span class="badge badge-warning">Не верифицирован</span>'}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `
          : '<p class="text-secondary">Нет пользователей</p>';
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }
    
    // Approve psychologist
    async function approve(id) {
      try {
        await API.admin.approvePsychologist(id);
        await loadPending();
        await loadStats();
        alert('Психолог одобрен');
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }
    
    // Reject psychologist
    async function reject(id) {
      if (!confirm('Вы уверены, что хотите отклонить эту заявку?')) return;
      try {
        await API.admin.rejectPsychologist(id);
        await loadPending();
        await loadStats();
        alert('Заявка отклонена');
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }
    
    // Make functions global
    window.approve = approve;
    window.reject = reject;
    
    // Initialize
    Auth.requireAuth('admin').then(ok => {
      if (ok) {
        loadStats();
        loadPending();
      }
    });
  </script>
</body>
</html>
