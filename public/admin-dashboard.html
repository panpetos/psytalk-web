<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель - psytalk.pro</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body style="background-color: #FAFAFA;">
  <!-- Navigation -->
  <nav class="nav" style="background-color: white; border-bottom: 1px solid #F0F0F0;">
    <div class="container">
      <div class="nav-container">
        <a href="/" class="nav-brand" data-testid="link-home" style="font-size: 1.25rem; font-weight: 600; word-spacing: 0; letter-spacing: 0;">
          <span style="color: #1A1A1A;">psy</span><!--
       --><span style="color: #7C3AED; font-style: italic;">talk.pro</span>
        </a>
        
        <button class="burger-menu" id="burgerMenu" data-testid="button-burger-menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        
        <ul class="nav-menu" id="navMenu">
          <li><a href="/admin-dashboard.html" class="nav-link" style="color: #7C3AED; font-weight: 600;" data-testid="link-dashboard">Панель управления</a></li>
          <li style="margin-left: 2rem;"><button class="btn btn-ghost btn-sm" id="logout-btn" data-testid="button-logout">Выйти</button></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="section" style="padding: 2rem 0;">
    <div class="container">
      <!-- Header -->
      <div class="mb-6">
        <h1 class="font-bold mb-2" style="font-size: 2rem; color: #1A1A1A;" data-testid="text-page-title">
          Админ-панель
        </h1>
        <p style="color: #666;">Управление платформой и модерация пользователей</p>
      </div>

      <!-- Stats Grid -->
      <div class="grid mb-6" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
        <!-- Stat 1 -->
        <div class="card" style="background: linear-gradient(135deg, #7C3AED 0%, #A78BFA 100%); padding: 1.5rem; color: white;">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div style="width: 3rem; height: 3rem; background: rgba(255,255,255,0.2); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i data-lucide="users" style="width: 1.5rem; height: 1.5rem;"></i>
            </div>
            <div>
              <div style="font-size: 0.875rem; opacity: 0.9;">Всего пользователей</div>
              <div style="font-size: 2rem; font-weight: 700;" id="stat-users" data-testid="text-stat-users">-</div>
            </div>
          </div>
        </div>

        <!-- Stat 2 -->
        <div class="card" style="background: linear-gradient(135deg, #EC4899 0%, #F472B6 100%); padding: 1.5rem; color: white;">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div style="width: 3rem; height: 3rem; background: rgba(255,255,255,0.2); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i data-lucide="briefcase" style="width: 1.5rem; height: 1.5rem;"></i>
            </div>
            <div>
              <div style="font-size: 0.875rem; opacity: 0.9;">Психологов</div>
              <div style="font-size: 2rem; font-weight: 700;" id="stat-psychologists" data-testid="text-stat-psychologists">-</div>
            </div>
          </div>
        </div>

        <!-- Stat 3 -->
        <div class="card" style="background: linear-gradient(135deg, #F59E0B 0%, #FCD34D 100%); padding: 1.5rem; color: white;">
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
            <div style="width: 3rem; height: 3rem; background: rgba(255,255,255,0.2); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i data-lucide="clock" style="width: 1.5rem; height: 1.5rem;"></i>
            </div>
            <div>
              <div style="font-size: 0.875rem; opacity: 0.9;">На модерации</div>
              <div style="font-size: 2rem; font-weight: 700;" id="stat-pending" data-testid="text-stat-pending">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs mb-4">
        <ul class="tab-list" style="display: flex; gap: 0.5rem; border-bottom: 2px solid #F0F0F0; padding: 0; list-style: none; overflow-x: auto;">
          <li>
            <button class="tab-button active" data-tab="pending" style="padding: 1rem 1.5rem; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s;">
              <i data-lucide="user-check" style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.5rem;"></i>
              Модерация
            </button>
          </li>
          <li>
            <button class="tab-button" data-tab="users" style="padding: 1rem 1.5rem; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #666; transition: all 0.2s;">
              <i data-lucide="users" style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.5rem;"></i>
              Пользователи
            </button>
          </li>
        </ul>
      </div>

      <!-- Pending Tab -->
      <div id="pending-tab" class="tab-content active">
        <div class="card" style="padding: 1.5rem;">
          <h3 class="font-semibold mb-4" style="font-size: 1.25rem; color: #1A1A1A;">
            Психологи на модерации
          </h3>
          <div id="pending-list" data-testid="list-pending">
            <div style="text-align: center; padding: 2rem;">
              <div style="display: inline-block; width: 3rem; height: 3rem; border: 3px solid #7C3AED; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users-tab" class="tab-content" style="display: none;">
        <div class="card" style="padding: 1.5rem;">
          <h3 class="font-semibold mb-4" style="font-size: 1.25rem; color: #1A1A1A;">
            Все пользователи
          </h3>
          <div id="users-list" data-testid="list-users">
            <div style="text-align: center; padding: 2rem;">
              <div style="display: inline-block; width: 3rem; height: 3rem; border: 3px solid #7C3AED; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    // Burger menu
    const burgerMenu = document.getElementById('burgerMenu');
    const navMenu = document.getElementById('navMenu');
    
    burgerMenu.addEventListener('click', () => {
      navMenu.classList.toggle('active');
      burgerMenu.classList.toggle('active');
      document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : '';
    });

    // Close menu on link click
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', () => {
        navMenu.classList.remove('active');
        burgerMenu.classList.remove('active');
        document.body.style.overflow = '';
      });
    });

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.dataset.tab;
        
        // Update button styles
        document.querySelectorAll('.tab-button').forEach(b => {
          b.classList.remove('active');
          b.style.color = '#666';
          b.style.borderBottomColor = 'transparent';
        });
        button.classList.add('active');
        button.style.color = '#7C3AED';
        button.style.borderBottomColor = '#7C3AED';
        
        // Switch content
        document.querySelectorAll('.tab-content').forEach(t => {
          t.style.display = 'none';
        });
        document.getElementById(`${tab}-tab`).style.display = 'block';
        
        if (tab === 'users') loadUsers();
      });
    });

    // Initialize active tab style
    const activeButton = document.querySelector('.tab-button.active');
    if (activeButton) {
      activeButton.style.color = '#7C3AED';
      activeButton.style.borderBottomColor = '#7C3AED';
    }

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await Auth.logout();
      window.location.href = '/';
    });

    // Load stats
    async function loadStats() {
      try {
        const stats = await API.admin.getStats();
        document.getElementById('stat-users').textContent = stats.totalUsers;
        document.getElementById('stat-psychologists').textContent = stats.totalPsychologists;
        document.getElementById('stat-pending').textContent = stats.pendingPsychologists;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load pending psychologists
    async function loadPending() {
      try {
        const pending = await API.admin.getPendingPsychologists();
        const listEl = document.getElementById('pending-list');
        
        if (pending.length === 0) {
          listEl.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #999;">
              <i data-lucide="check-circle" style="width: 3rem; height: 3rem; margin-bottom: 1rem;"></i>
              <p>Нет психологов на модерации</p>
            </div>
          `;
          lucide.createIcons();
          return;
        }
        
        listEl.innerHTML = pending.map(psych => `
          <div class="card mb-3" style="padding: 1.5rem; border-left: 4px solid #7C3AED;" data-testid="card-psychologist-${psych.id}">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <!-- Header -->
              <div style="display: flex; align-items: start; justify-content: space-between; gap: 1rem;">
                <div style="flex: 1;">
                  <h4 class="font-semibold mb-1" style="font-size: 1.125rem; color: #1A1A1A;">
                    ${psych.user.firstName} ${psych.user.lastName}
                  </h4>
                  <p style="color: #666; font-size: 0.875rem;">
                    <i data-lucide="mail" style="width: 0.875rem; height: 0.875rem; display: inline; vertical-align: middle;"></i>
                    ${psych.user.email}
                  </p>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem; background: #F3E8FF; padding: 0.5rem 1rem; border-radius: 2rem; white-space: nowrap;">
                  <i data-lucide="clock" style="width: 1rem; height: 1rem; color: #7C3AED;"></i>
                  <span style="font-size: 0.875rem; font-weight: 600; color: #7C3AED;">На модерации</span>
                </div>
              </div>

              <!-- Info Grid -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem; background: #FAFAFA; border-radius: 0.5rem;">
                <div>
                  <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; margin-bottom: 0.25rem;">Специализация</div>
                  <div style="color: #1A1A1A; font-weight: 500;">${psych.specialization}</div>
                </div>
                <div>
                  <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; margin-bottom: 0.25rem;">Опыт работы</div>
                  <div style="color: #1A1A1A; font-weight: 500;">${psych.experience} лет</div>
                </div>
                <div>
                  <div style="font-size: 0.75rem; color: #999; text-transform: uppercase; margin-bottom: 0.25rem;">Стоимость сессии</div>
                  <div style="color: #1A1A1A; font-weight: 500;">${psych.price} ₽</div>
                </div>
              </div>

              <!-- Education -->
              <div>
                <div style="font-size: 0.875rem; font-weight: 600; color: #1A1A1A; margin-bottom: 0.5rem;">Образование</div>
                <p style="color: #666; font-size: 0.875rem;">${psych.education}</p>
              </div>

              <!-- Description -->
              <div>
                <div style="font-size: 0.875rem; font-weight: 600; color: #1A1A1A; margin-bottom: 0.5rem;">О себе</div>
                <p style="color: #666; font-size: 0.875rem; line-height: 1.6;">${psych.description}</p>
              </div>

              <!-- Actions -->
              <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button 
                  class="btn" 
                  onclick="approve('${psych.id}')" 
                  style="flex: 1; min-width: 150px; background: #7C3AED; color: white; border: none; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                  data-testid="button-approve-${psych.id}"
                >
                  <i data-lucide="check-circle" style="width: 1rem; height: 1rem;"></i>
                  Одобрить
                </button>
                <button 
                  class="btn btn-outline" 
                  onclick="reject('${psych.id}')" 
                  style="flex: 1; min-width: 150px; border-color: #EF4444; color: #EF4444; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                  data-testid="button-reject-${psych.id}"
                >
                  <i data-lucide="x-circle" style="width: 1rem; height: 1rem;"></i>
                  Отклонить
                </button>
              </div>
            </div>
          </div>
        `).join('');
        
        lucide.createIcons();
      } catch (error) {
        console.error('Error loading pending:', error);
        document.getElementById('pending-list').innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #EF4444;">
            <p>Ошибка загрузки данных</p>
          </div>
        `;
      }
    }

    // Load all users
    async function loadUsers() {
      try {
        const users = await API.admin.getUsers();
        const listEl = document.getElementById('users-list');
        
        if (users.length === 0) {
          listEl.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #999;">
              <p>Нет пользователей</p>
            </div>
          `;
          return;
        }

        // Group by role
        const clients = users.filter(u => u.role === 'client');
        const psychologists = users.filter(u => u.role === 'psychologist');
        const admins = users.filter(u => u.role === 'admin');

        listEl.innerHTML = `
          <!-- Admins -->
          ${admins.length > 0 ? `
            <div class="mb-4">
              <h4 class="font-semibold mb-3" style="color: #7C3AED; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="shield" style="width: 1.25rem; height: 1.25rem;"></i>
                Администраторы (${admins.length})
              </h4>
              <div style="display: grid; gap: 0.75rem;">
                ${admins.map(user => renderUserCard(user)).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Psychologists -->
          ${psychologists.length > 0 ? `
            <div class="mb-4">
              <h4 class="font-semibold mb-3" style="color: #EC4899; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="briefcase" style="width: 1.25rem; height: 1.25rem;"></i>
                Психологи (${psychologists.length})
              </h4>
              <div style="display: grid; gap: 0.75rem;">
                ${psychologists.map(user => renderUserCard(user)).join('')}
              </div>
            </div>
          ` : ''}

          <!-- Clients -->
          ${clients.length > 0 ? `
            <div class="mb-4">
              <h4 class="font-semibold mb-3" style="color: #666; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="user" style="width: 1.25rem; height: 1.25rem;"></i>
                Клиенты (${clients.length})
              </h4>
              <div style="display: grid; gap: 0.75rem;">
                ${clients.map(user => renderUserCard(user)).join('')}
              </div>
            </div>
          ` : ''}
        `;
        
        lucide.createIcons();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-list').innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #EF4444;">
            <p>Ошибка загрузки данных</p>
          </div>
        `;
      }
    }

    function renderUserCard(user) {
      const roleColors = {
        admin: { bg: '#F3E8FF', color: '#7C3AED', icon: 'shield' },
        psychologist: { bg: '#FCE7F3', color: '#EC4899', icon: 'briefcase' },
        client: { bg: '#F5F5F5', color: '#666', icon: 'user' }
      };
      const roleStyle = roleColors[user.role] || roleColors.client;
      const isBlocked = user.is_frozen;

      return `
        <div class="card" style="padding: 1rem; background: white; ${isBlocked ? 'opacity: 0.6; border-left: 4px solid #EF4444;' : ''}" data-testid="card-user-${user.id}">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                <div style="font-weight: 600; color: #1A1A1A;">${user.firstName} ${user.lastName}</div>
                <div style="display: flex; align-items: center; gap: 0.25rem; background: ${roleStyle.bg}; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; color: ${roleStyle.color};">
                  <i data-lucide="${roleStyle.icon}" style="width: 0.75rem; height: 0.75rem;"></i>
                  ${user.role === 'admin' ? 'Админ' : user.role === 'psychologist' ? 'Психолог' : 'Клиент'}
                </div>
                ${isBlocked ? `
                  <div style="display: flex; align-items: center; gap: 0.25rem; background: #FEE2E2; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600; color: #EF4444;">
                    <i data-lucide="ban" style="width: 0.75rem; height: 0.75rem;"></i>
                    Заблокирован
                  </div>
                ` : ''}
              </div>
              <div style="color: #666; font-size: 0.875rem;">${user.email}</div>
            </div>
            ${user.role !== 'admin' ? `
              <button 
                onclick="${isBlocked ? 'unblockUser' : 'blockUser'}('${user.id}')" 
                class="btn btn-sm ${isBlocked ? '' : 'btn-outline'}"
                style="${isBlocked ? 'background: #10B981; color: white; border: none;' : 'border-color: #EF4444; color: #EF4444;'}"
                data-testid="button-block-${user.id}"
              >
                <i data-lucide="${isBlocked ? 'unlock' : 'ban'}" style="width: 0.875rem; height: 0.875rem; display: inline; vertical-align: middle; margin-right: 0.25rem;"></i>
                ${isBlocked ? 'Разблокировать' : 'Заблокировать'}
              </button>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Approve psychologist
    async function approve(id) {
      if (!confirm('Одобрить заявку психолога?')) return;
      
      try {
        await API.admin.approvePsychologist(id);
        await loadStats();
        await loadPending();
        alert('Психолог успешно одобрен!');
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    // Reject psychologist
    async function reject(id) {
      if (!confirm('Отклонить заявку психолога? Это действие нельзя отменить.')) return;
      
      try {
        await API.admin.rejectPsychologist(id);
        await loadStats();
        await loadPending();
        alert('Заявка отклонена');
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    // Block user
    async function blockUser(id) {
      if (!confirm('Заблокировать пользователя?')) return;
      
      try {
        await API.admin.blockUser(id);
        await loadUsers();
        await loadStats();
        alert('Пользователь заблокирован');
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    // Unblock user
    async function unblockUser(id) {
      if (!confirm('Разблокировать пользователя?')) return;
      
      try {
        await API.admin.unblockUser(id);
        await loadUsers();
        await loadStats();
        alert('Пользователь разблокирован');
      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    // Initialize
    Auth.checkAuth().then(() => {
      if (!Auth.currentUser || Auth.currentUser.role !== 'admin') {
        window.location.href = '/login.html';
        return;
      }
      
      loadStats();
      loadPending();
      lucide.createIcons();
    });
  </script>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr !important;
      }

      .tab-list {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tab-button {
        white-space: nowrap;
        font-size: 0.875rem !important;
        padding: 0.75rem 1rem !important;
      }
    }
  </style>
</body>
</html>
