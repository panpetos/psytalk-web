<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Консультация - PsychPlatform</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container" style="margin-top: 40px;">
    <div class="card">
      <div class="flex justify-between items-center mb-3">
        <h1 class="mb-0">Консультация</h1>
        <button class="btn btn-danger" onclick="window.history.back()">Завершить</button>
      </div>
      
      <div id="consultation-info" class="mb-3">
        <div class="spinner"></div>
      </div>
      
      <div class="grid grid-cols-2">
        <div class="card" style="background: var(--color-bg-secondary);">
          <h3>Видео</h3>
          <div id="video-container" style="background: #000; border-radius: var(--radius-md); aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; color: white;">
            <p>Видео-функционал будет доступен в следующей версии</p>
          </div>
        </div>
        
        <div class="card" style="background: var(--color-bg-secondary);">
          <h3>Чат</h3>
          <div id="messages" style="height: 300px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
            <p class="text-secondary text-center">Сообщений пока нет</p>
          </div>
          
          <div class="flex gap-2">
            <input type="text" id="message-input" class="form-input" placeholder="Введите сообщение..." style="margin-bottom: 0;">
            <button class="btn" onclick="sendMessage()">Отправить</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const appointmentId = urlParams.get('id');
    let currentUser = null;
    let appointment = null;
    
    // Load appointment info
    async function loadAppointment() {
      if (!appointmentId) {
        document.getElementById('consultation-info').innerHTML = '<p class="text-danger">Консультация не найдена</p>';
        return;
      }
      
      try {
        // Note: We need to add a getAppointment endpoint or load from client/psychologist appointments
        document.getElementById('consultation-info').innerHTML = `
          <div class="alert alert-info">
            <p><strong>ID консультации:</strong> ${appointmentId}</p>
            <p class="mb-0"><strong>Формат:</strong> Видео/Аудио/Чат</p>
          </div>
        `;
      } catch (error) {
        console.error('Error loading appointment:', error);
      }
    }
    
    // Send message
    function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      const messagesDiv = document.getElementById('messages');
      const messageEl = document.createElement('div');
      messageEl.className = 'card mb-2';
      messageEl.style.background = 'white';
      messageEl.innerHTML = `
        <p class="text-sm text-secondary mb-1">${currentUser.firstName} ${currentUser.lastName}</p>
        <p class="mb-0">${message}</p>
      `;
      
      if (messagesDiv.querySelector('.text-center')) {
        messagesDiv.innerHTML = '';
      }
      
      messagesDiv.appendChild(messageEl);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      input.value = '';
    }
    
    // Allow Enter to send message
    document.getElementById('message-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Make sendMessage global
    window.sendMessage = sendMessage;
    
    // Initialize
    Auth.requireAuth().then(ok => {
      if (ok) {
        currentUser = Auth.getUser();
        loadAppointment();
      }
    });
  </script>
</body>
</html>
