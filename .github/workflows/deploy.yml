name: üöÄ Deploy Vite front to REG.RU

on:
  push:
    branches: [ main ]    # –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js 20
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install dependencies
        run: npm ci || npm i

      # 4. –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç Vite
      - name: Build project
        run: npm run build

      # 5. –î–æ–±–∞–≤–ª—è–µ–º .htaccess –≤ dist –¥–ª—è SPA –∏ HTTPS
      - name: Add .htaccess to dist
        run: |
          cat > dist/.htaccess << 'EOF'
          # –í–∫–ª—é—á–∞–µ–º —Å–∂–∞—Ç–∏–µ
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
          </IfModule>

          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ HTTPS –∏ –±–µ–∑ www
          RewriteEngine On
          RewriteCond %{HTTPS} off [OR]
          RewriteCond %{HTTP_HOST} ^www\.psytalk\.pro [NC]
          RewriteRule ^(.*)$ https://psytalk.pro/$1 [L,R=301]

          # SPA fallback ‚Äî —á—Ç–æ–±—ã React/Vue –º–∞—Ä—à—Ä—É—Ç—ã —Ä–∞–±–æ—Ç–∞–ª–∏
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]

          # –û—Ç–∫–ª—é—á–∞–µ–º –∫—ç—à –¥–ª—è HTML
          <IfModule mod_headers.c>
            <FilesMatch "\.html$">
              Header set Cache-Control "no-cache, no-store, must-revalidate"
              Header set Pragma "no-cache"
              Header set Expires "0"
            </FilesMatch>
          </IfModule>
          EOF

      # 6. –ó–∞–ª–∏–≤–∞–µ–º –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ REG.RU —á–µ—Ä–µ–∑ FTP
      - name: Upload via FTP to REG.RU
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          local-dir: ./dist/           # –∫—É–¥–∞ –±–∏–ª–¥–∏—Ç Vite
          server-dir: /www/psytalk.pro/ # –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          dangerous-clean-slate: true  # —á–∏—Å—Ç–∏—Ç —Ç–æ–ª—å–∫–æ dist, –∞ –Ω–µ API
          log-level: verbose
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/*.map
            api/**
            *.php
            *.json
            *.md
